version: 2.1
orbs:
  cypress: cypress-io/cypress@1
  node: circleci/node@1.1.6

executors:
  base10-foo-bar:
    docker:
      - image: "cypress/base:10"
        environment:
          URI: postgres://circleci:super-secret@localhost/nhs_visit
          ALLOWED_CODES: VALIDCODE
      - image: circleci/postgres:12
        environment:
          POSTGRES_USER: circleci
          POSTGRES_PASSWORD: super-secret
          POSTGRES_DB: nhs_visit

jobs:
  build-and-test:
    executor:
      name: node/default
    steps:
      - checkout
      - node/with-cache:
          steps:
            - run: npm install
            - run: npm rebuild node-sass
            - run: npm run test:ci
            - run: npm run build

workflows:
  build:
    jobs:
      - build-and-test
      - cypress/install:
          build: "npm run build" # run a custom app build step
      - cypress/run:
          executor: base10-foo-bar
          requires:
            - cypress/install
          parallel: true # split all specs across machines
          parallelism: 4 # use 4 CircleCI machines to finish quickly
          group: "all tests" # name this group "all tests" on the dashboard
          start: "npm run dev" # start server before running tests
          store_artifacts: true
